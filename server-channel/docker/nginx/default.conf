server {
    # Listen on port 80
    listen 80;
    server_name localhost;

    # Root directory and index files
    root /var/www/public/html;
    index index.php index.html;

    # Logging
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;

    # === START REACT APP LOCATION BLOCK (HIGH PRIORITY) ===
  # This block is designed to be very specific and aggressive for /ui/ requests.
  location /ui/ {
      # 'alias' maps the URL /ui/ to the filesystem path /var/www/public/html/ui/
      alias /var/www/public/html/ui/;

      # Try to serve a direct file (e.g., /ui/static/js/main.js)
      # Or a directory's index (less common for SPAs within a subfolder).
      # If found, Nginx stops processing here.
      try_files $uri $uri/ @react_app_fallback; # If static file not found, use named location
  }

  # Named location for React app fallback.
  # This ensures that any path under /ui/ that isn't a physical file/directory
  # gets served by the React app's index.html.
  location @react_app_fallback {
      # Rewrite the internal URI to the React app's index.html.
      # The 'alias' directive has already set the root for this context,
      # so 'index.html' refers to /var/www/public/html/ui/index.html.
      rewrite ^/ui/(.*)$ /ui/index.html last; # Crucial rewrite for all sub-paths
  }
  # === END REACT APP LOCATION BLOCK ===



    #Try files or directories, fallback to PHP
    location / {
        try_files $uri $uri/ /index.html /index.php?$query_string;  # @php_fallback;
    }

    #location @php_fallback{
    #  #rewrite ^(.*)$ /html/index.php last;
    #  # Pass to PHP container
    #  fastcgi_pass php:9000;
    #  fastcgi_index index.php;

    #  # Important! This tells PHP what file to process
    #  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    #  # Include standard FastCGI parameters
    #  include fastcgi_params;

    #  # Some extra settings for better performance
    #  fastcgi_buffer_size 128k;
    #  fastcgi_buffers 4 256k;
    #  fastcgi_busy_buffers_size 256k;

    #}




  #  location ~ ^/(.*)\.(html)$ {
  #        if (-f $document_root/html/$1.$2) {
  #            rewrite ^/(.*)\.(html)$ /html/$1.$2 last;
  #        }
  #        try_files $uri =404;
  #    }

    location ~ ^/(.*)\.(php)$ {
          if (-f $document_root/html/$1.$2) {
              rewrite ^/(.*)\.(php)$ /html/$1.$2 last;
          }
          # Pass to PHP container
          fastcgi_pass php:9000;
          fastcgi_index index.php;

          # Important! This tells PHP what file to process
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

          # Include standard FastCGI parameters
          include fastcgi_params;

          # Some extra settings for better performance
          fastcgi_buffer_size 128k;
          fastcgi_buffers 4 256k;
          fastcgi_busy_buffers_size 256k;
      }

    # Handle PHP files
    location ~ \.php$ {
        # Pass to PHP container
        fastcgi_pass php:9000;
        fastcgi_index index.php;

        # Important! This tells PHP what file to process
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # Include standard FastCGI parameters
        include fastcgi_params;

        # Some extra settings for better performance
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
    }

    # Deny access to hidden files
    #location ~ /\. {
    #    deny all;
    #}

    location ~ /\.\w+ {
    deny all;
    }
}
